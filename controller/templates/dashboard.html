<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Universal Controller</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 40px; background-color: #f4f4f9; }
        h1 { color: #333; margin-bottom: 20px; }
        
        /* The Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-top: 4px solid #ccc; /* Default grey */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Dynamic Status Colors */
        .card.status-running { border-top-color: #28a745; }
        .card.status-stopped { border-top-color: #dc3545; }

        .tool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .tool-name { font-size: 1.2em; font-weight: bold; color: #333; text-transform: capitalize; }
        .tool-port { font-size: 0.8em; color: #888; background: #eee; padding: 2px 6px; border-radius: 4px; }

        .status-text { font-size: 0.9em; margin-bottom: 15px; font-weight: 500; }
        
        /* Action Buttons */
        .actions { display: flex; gap: 10px; }
        button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        .btn-launch { background-color: #28a745; }
        .btn-kill   { background-color: #dc3545; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }

        /* Specific Tool Controls area (expandable later) */
        .custom-controls {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
            font-size: 0.85em;
        }
        .btn-cmd { background-color: #007bff; font-size: 0.8em; padding: 5px; width: 100%; margin-top: 5px;}

    </style>
</head>
<body>

<h1>üéõÔ∏è Utility Controller</h1>
<div id="tools-container" class="grid-container">
    </div>

<script>
    // 1. Master Loop: Fetch all tools and render
    async function loadDashboard() {
        const container = document.getElementById('tools-container');
        
        try {
            const resp = await fetch('/tools');
            const data = await resp.json();
            const tools = data.tools;

            container.innerHTML = ''; // Clear current

            for (const tool of tools) {
                const card = createToolCard(tool);
                container.appendChild(card);
                
                // Check actual liveliness for each
                checkAlive(tool.name);
            }
        } catch (e) {
            container.innerHTML = '<p>Error loading tools. Is Controller running?</p>';
        }
    }

    // 2. Component: Build the HTML for a single card
    function createToolCard(tool) {
        const div = document.createElement('div');
        div.className = `card status-${tool.status}`;
        div.id = `card-${tool.name}`;

        // If it's the Blocker, we can add special buttons. 
        // Later, we can make this generic via a "manifest", but for now hardcoding specific buttons is safer.
        let customHtml = '';
        if (tool.name === 'blocker') {
            customHtml = `
                <div class="custom-controls">
                    <strong>Internal Service:</strong>
                    <button class="btn-cmd" onclick="proxyCmd('${tool.name}', 'start')">‚ñ∂ Start Logic</button>
                    <button class="btn-cmd" style="background:#6c757d" onclick="proxyCmd('${tool.name}', 'stop')">‚è∏ Stop Logic</button>
                </div>
            `;
        }

        div.innerHTML = `
            <div class="tool-header">
                <span class="tool-name">${tool.name}</span>
                <span class="tool-port">:${tool.port}</span>
            </div>
            <div class="status-text" id="status-${tool.name}">
                Status: ${tool.status.toUpperCase()}
            </div>
            <div class="actions">
                <button class="btn-launch" onclick="controlProcess('${tool.name}', 'launch')">üöÄ Launch</button>
                <button class="btn-kill" onclick="controlProcess('${tool.name}', 'kill')">üíÄ Kill</button>
            </div>
            ${customHtml}
        `;
        return div;
    }

    // 3. Actions: Launch / Kill Process
    async function controlProcess(name, action) {
        const btn = document.querySelector(`#card-${name} .btn-${action}`);
        const originalText = btn.innerText;
        btn.innerText = "...";
        
        await fetch(`/tools/${name}/${action}`, { method: 'POST' });
        
        // Brief delay to let process settle, then refresh status
        setTimeout(() => checkAlive(name), 1000);
        btn.innerText = originalText;
    }

    // 4. Actions: Proxy Commands (e.g. Blocker start/stop)
    async function proxyCmd(name, action) {
        try {
            const res = await fetch(`/api/tools/${name}/${action}`, { method: 'POST' });
            const data = await res.json();
            alert(`${name} says: ${JSON.stringify(data)}`);
        } catch(e) {
            alert(`Error contacting ${name}. Is the process running?`);
        }
    }

    // 5. Polling: Check status
    async function checkAlive(name) {
        const resp = await fetch(`/tools/${name}/alive`);
        const data = await resp.json();
        
        const card = document.getElementById(`card-${name}`);
        const statusText = document.getElementById(`status-${name}`);
        
        if (data.alive) {
            card.classList.remove('status-stopped');
            card.classList.add('status-running');
            statusText.innerHTML = `<span style="color:green">‚óè PID: ${data.pid}</span>`;
        } else {
            card.classList.remove('status-running');
            card.classList.add('status-stopped');
            statusText.innerHTML = `<span style="color:red">‚óè Stopped</span>`;
        }
    }

    // Initial Load
    loadDashboard();
</script>

</body>
</html>
